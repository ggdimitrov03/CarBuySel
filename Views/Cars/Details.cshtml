@using System.Collections.Generic
@model CarListing
@{
    ViewData["Title"] = Model.Title;

    var galleryImages = Model.Images?.OrderBy(image => image.SortOrder).ToList() ?? new List<CarImage>();
    var mainImageId = $"gallery-main-{Model.Id}";

    var specRows = new Dictionary<string, string?>
    {
        ["Двигател"] = Model.SpecEngine,
        ["Мощност"] = Model.SpecPower,
        ["Разход"] = Model.SpecEconomy,
        ["Трансмисия"] = Model.SpecTransmission,
        ["Екстериор"] = Model.SpecExterior,
        ["Интериор"] = Model.SpecInterior,
        ["Асистенти"] = Model.SpecAssist,
        ["Свързаност"] = Model.SpecConnectivity
    }
    .Where(pair => !string.IsNullOrWhiteSpace(pair.Value))
    .ToList();

    if (!specRows.Any())
    {
        specRows = new Dictionary<string, string?>
        {
            ["Двигател"] = "3.0L Twin-Turbo · 4х4 · Performance настройка",
            ["Мощност"] = "456 к.с. / 520 Nm",
            ["Разход"] = "10.2 л / 100 км комбиниран",
            ["Трансмисия"] = "8-степенен автоматик с пера",
            ["Екстериор"] = "Obsidian Black · Керамично фолио",
            ["Интериор"] = "Премиум кожа · Амбиентно осветление",
            ["Асистенти"] = "Адаптивен круиз · 360° камери",
            ["Свързаност"] = "CarPlay · Android Auto · OTA актуализации"
        }.ToList();
    }

    var ownershipTimeline = new List<(string? Title, string? Subtitle, string? Date)>
    {
        (Model.History1Title, Model.History1Subtitle, Model.History1Date),
        (Model.History2Title, Model.History2Subtitle, Model.History2Date),
        (Model.History3Title, Model.History3Subtitle, Model.History3Date)
    }
    .Where(entry => !string.IsNullOrWhiteSpace(entry.Title) || !string.IsNullOrWhiteSpace(entry.Subtitle) || !string.IsNullOrWhiteSpace(entry.Date))
    .ToList();

    if (!ownershipTimeline.Any())
    {
        ownershipTimeline = new List<(string? Title, string? Subtitle, string? Date)>
        {
            ("Инспекция CarBuySell", "Няма грешки · батерия 92%", "Q4 2024"),
            ("Сертифициран сервиз", "Спирачна течност + гуми подменени", "Q3 2024"),
            ("Първи собственик (корп.)", "Лизинг за изпълнителен автопарк", "Q2 2023")
        };
    }

    var conditionItems = new List<string?>
    {
        Model.Condition1,
        Model.Condition2,
        Model.Condition3,
        Model.Condition4
    }.Where(item => !string.IsNullOrWhiteSpace(item)).ToList();

    if (!conditionItems.Any())
    {
        conditionItems = new List<string?>
        {
            "✔ Пълно PPF покритие по купето",
            "✔ Гуми > 6 мм · балансирани",
            "✔ Филтър купе + батерия проверени",
            "✔ Няма активни кампании"
        };
    }

    var recommendedVehicles = new[]
    {
        new { Title = $"{Model.Year} {Model.Make} {Model.Model} Black Series", Meta = "21,400 km · AWD", Price = "€118,500", Image = "https://images.unsplash.com/photo-1503736334956-4c8f8e92946d?auto=format&fit=crop&w=700&q=80" },
        new { Title = "2022 Aston Martin DBX 707", Meta = "14,700 km · Launch Edition", Price = "€169,000", Image = "https://images.unsplash.com/photo-1472214103451-9374bd1c798e?auto=format&fit=crop&w=700&q=80" },
        new { Title = "2023 Porsche Cayenne Turbo GT", Meta = "9,800 km · Carbon Pack", Price = "€188,400", Image = "https://images.unsplash.com/photo-1502877338535-766e1452684a?auto=format&fit=crop&w=700&q=80" }
    };
}

<section class="details-layout">
    <div class="details-gallery">
        @if (galleryImages.Any())
        {
            var hero = galleryImages.First();
            <div class="gallery-main position-relative">
                <img id="@mainImageId"
                     src="@Url.Content(hero.Path)"
                     class="gallery-main__img"
                     alt="Основна снимка на @Model.Title"
                     data-gallery="listing"
                     data-full="@Url.Content(hero.Path)"
                     data-gallery-index="0" />
                @if (galleryImages.Count > 1)
                {
                    <button type="button"
                            class="gallery-nav gallery-nav--prev"
                            data-gallery-nav
                            data-direction="prev"
                            data-target="@mainImageId"
                            aria-label="Предишна снимка">
                        ‹
                    </button>
                    <button type="button"
                            class="gallery-nav gallery-nav--next"
                            data-gallery-nav
                            data-direction="next"
                            data-target="@mainImageId"
                            aria-label="Следваща снимка">
                        ›
                    </button>
                }
            </div>
            @if (galleryImages.Count > 1)
            {
                <div class="gallery-thumbs mt-3">
                    @for (var index = 0; index < galleryImages.Count; index++)
                    {
                        var image = galleryImages[index];
                        <img src="@Url.Content(image.Path)"
                             class="gallery-thumb"
                             alt="Thumbnail of @Model.Title"
                             data-gallery="listing"
                             data-full="@Url.Content(image.Path)"
                             data-gallery-thumb-for="@mainImageId"
                             data-gallery-index="@index" />
                    }
                </div>
            }
        }
        else
        {
            <div class="details-media placeholder">
                <div class="price-tag price-tag--xl">@Model.Price.ToString("C0")</div>
            </div>
        }
    </div>
    <aside class="details-summary glass-card sticky-md">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <p class="text-uppercase text-muted small mb-1">Обява</p>
                <h1 class="h3 mb-0">@Model.Title</h1>
                <p class="text-muted">@Model.Make · @Model.Model · @Model.Year</p>
            </div>
        </div>
        <div class="details-price mb-3">@Model.Price.ToString("C0")</div>
        <div class="summary-list">
            <div>
                <span class="label">Състояние</span>
                <strong>Сертифициран премиум</strong>
            </div>
            <div>
                <span class="label">Публикувана</span>
                <strong>@Model.CreatedAt.ToLocalTime().ToString("dd MMM yyyy")</strong>
            </div>
            <div>
                <span class="label">Продавач</span>
                <strong>@(Model.Owner?.DisplayName ?? "Потвърден профил")</strong>
            </div>
            <div>
                <span class="label">Наличност</span>
                <strong>Готов за доставка</strong>
            </div>
        </div>
        <p class="text-muted mb-4">@Model.Description</p>
        <div class="d-grid gap-2">
            <a class="btn btn-danger btn-lg" href="mailto:@Model.Owner?.Email">Свържи се с продавача</a>
            <a class="btn btn-outline-light btn-lg" asp-action="Index">Назад към обявите</a>
        </div>
    </aside>
</section>

<section class="details-content">
    <div class="glass-card spec-card">
        <div class="section-header">
            <div>
                <p class="eyebrow text-emerald mb-1">Спецификации</p>
                <h2 class="h4 mb-0">Данни за автомобила</h2>
            </div>
        </div>
        @if (specRows.Any())
        {
            <table class="spec-table">
                <tbody>
                    @foreach (var spec in specRows)
                    {
                        <tr>
                            <th scope="row">@spec.Key</th>
                            <td>@spec.Value</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p class="text-muted mb-0">Все още няма въведени спецификации.</p>
        }
    </div>

    <div class="glass-card history-card">
        <div class="section-header">
            <div>
                <p class="eyebrow text-emerald mb-1">История</p>
                <h2 class="h4 mb-0">Проследяване и поддръжка</h2>
            </div>
        </div>
        @if (ownershipTimeline.Any())
        {
            <div class="history-timeline">
                @foreach (var eventItem in ownershipTimeline)
                {
                    <div class="history-step">
                        <span class="history-step__dot"></span>
                        <div>
                            <strong>@eventItem.Title</strong>
                            <p class="text-muted mb-1">@eventItem.Subtitle</p>
                            <span class="history-step__date">@eventItem.Date</span>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <p class="text-muted mb-0">Няма добавена история.</p>
        }
    </div>

    <div class="glass-card condition-card">
        <div class="section-header">
            <div>
                <p class="eyebrow text-emerald mb-1">Състояние</p>
                <h2 class="h4 mb-0">Акценти от инспекция</h2>
            </div>
        </div>
        @if (conditionItems.Any())
        {
            <ul class="condition-list">
                @foreach (var item in conditionItems)
                {
                    <li>✔ @item</li>
                }
            </ul>
        }
        else
        {
            <p class="text-muted mb-0">Добавете кратко описание на състоянието, когато редактирате обявата.</p>
        }
    </div>
</section>

<section class="home-section recommendations">
    <div class="section-header">
        <div>
            <p class="eyebrow text-emerald mb-1">Препоръчани</p>
            <h2 class="h4 mb-0">Купувачите също разгледаха</h2>
        </div>
        <a class="btn btn-outline-emerald btn-sm" asp-controller="Cars" asp-action="Index">Виж всички</a>
    </div>
    <div class="recommendation-carousel">
        @foreach (var car in recommendedVehicles)
        {
            <article class="recommend-card hover-card">
                <div class="recommend-card__image" style="background-image: url('@car.Image');"></div>
                <div class="recommend-card__body">
                    <div>
                        <h3 class="h6 mb-1">@car.Title</h3>
                        <p class="text-muted small mb-2">@car.Meta</p>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="feature-card__price">@car.Price</span>
                        <a class="btn btn-sm btn-outline-light" asp-controller="Cars" asp-action="Index">Виж</a>
                    </div>
                </div>
            </article>
        }
    </div>
</section>
